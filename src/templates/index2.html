<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiSig Wallet</title>

    <!-- Vincula tu CSS original -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>

<section id="content">
    <nav>
        <img src="{{ url_for('static', filename='img/people.png') }}" alt="User Image">
        <button id="connect-button" onclick="connectMetaMask()">Conectar MetaMask</button>
    </nav>

    <div class="box-info">
        <i class='bx bxs-dollar-circle'></i>
        <span class="text">
            <h3>Saldo actual</h3>
            <p id="balance">0 ETH</p>
        </span>
    </div>

    <table>
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Valor</th>
                <th>Ejecutado</th>
                <th>Firmas</th>
                <th>Motivo</th>
            </tr>
        </thead>
        <tbody id="transactions">
            <!-- Las transacciones se llenarán aquí -->
        </tbody>
    </table>
</section>

<script type="text/javascript">
    let web3;
    let contract;
    const contractAddress = "0xe528C4eC8a6E255e16258552F424125b1a620F21";  // Reemplaza con la dirección de tu contrato
    const contractAbi = [
		{
			"inputs": [
				{
					"internalType": "address[]",
					"name": "_owners",
					"type": "address[]"
				},
				{
					"internalType": "uint256",
					"name": "_requiredSignatures",
					"type": "uint256"
				}
			],
			"stateMutability": "nonpayable",
			"type": "constructor"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "owner",
					"type": "address"
				}
			],
			"name": "OwnerAdded",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "owner",
					"type": "address"
				}
			],
			"name": "OwnerRemoved",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "uint256",
					"name": "txIndex",
					"type": "uint256"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "TransactionSubmitted",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "uint256",
					"name": "txIndex",
					"type": "uint256"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "owner",
					"type": "address"
				}
			],
			"name": "TransactionSigned",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "uint256",
					"name": "txIndex",
					"type": "uint256"
				}
			],
			"name": "TransactionExecuted",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "newRequiredSignatures",
					"type": "uint256"
				}
			],
			"name": "RequiredSignaturesUpdated",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "newOwner",
					"type": "address"
				}
			],
			"name": "addOwner",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_txIndex",
					"type": "uint256"
				}
			],
			"name": "executeTransaction",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_txIndex",
					"type": "uint256"
				}
			],
			"name": "getTransaction",
			"outputs": [
				{
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				},
				{
					"internalType": "bytes",
					"name": "data",
					"type": "bytes"
				},
				{
					"internalType": "bool",
					"name": "executed",
					"type": "bool"
				},
				{
					"internalType": "uint256",
					"name": "signatureCount",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "owner",
					"type": "address"
				}
			],
			"name": "removeOwner",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "owners",
			"outputs": [
				{
					"internalType": "address[]",
					"name": "",
					"type": "address[]"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "transactions",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_newRequiredSignatures",
					"type": "uint256"
				}
			],
			"name": "updateRequiredSignatures",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "_to",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "_value",
					"type": "uint256"
				},
				{
					"internalType": "bytes",
					"name": "_data",
					"type": "bytes"
				}
			],
			"name": "submitTransaction",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_txIndex",
					"type": "uint256"
				}
			],
			"name": "signTransaction",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"stateMutability": "payable",
			"type": "receive"
		}
	];


    // Conectar automáticamente a MetaMask si está disponible
    window.addEventListener('load', function() {
        if (typeof window.ethereum !== 'undefined') {
            connectMetaMask();
        }
    });

    async function connectMetaMask() {
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const accounts = await web3.eth.getAccounts();
                console.log("Connected account:", accounts[0]);

                // Ocultar el botón de conexión después de conectar
                document.getElementById('connect-button').style.display = 'none';

                contract = new web3.eth.Contract(contractAbi, contractAddress);

                // Obtener saldo y mostrarlo
                const balance = await web3.eth.getBalance(contractAddress);
                document.getElementById('balance').textContent = web3.utils.fromWei(balance, 'ether') + ' ETH';

                // Obtener y mostrar las transacciones
                const transactionCount = await contract.methods.transactions().call();
                let transactionsTable = document.getElementById('transactions');

                for (let i = 0; i < transactionCount; i++) {
                    let tx = await contract.methods.getTransaction(i).call();
                    let newRow = transactionsTable.insertRow();
                    newRow.innerHTML = `<td>${tx.to}</td><td>${web3.utils.fromWei(tx.value, 'ether')} ETH</td><td>${tx.executed}</td><td>${tx.signatureCount}</td><td>${tx.data}</td>`;
                }
            } catch (error) {
                console.error("User denied account access");
            }
        } else {
            console.error("MetaMask is not installed");
        }
    }
</script>

</body>
</html>
